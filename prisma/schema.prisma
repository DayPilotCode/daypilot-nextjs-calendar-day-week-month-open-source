generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ExperienceLevel {
  JUNIOR
  INTERMEDIATE
  SENIOR
}

enum Role {
  TEAM_MEMBER
  SHIFT_LEAD
  EXECUTIVE
}

enum ShiftType {
  MOBILE_TEAM_1
  MOBILE_TEAM_2
  STATIONARY
  EXECUTIVE
}

enum ShiftPriority {
  BUFFER
  CORE
}

enum EventStatus {
  PLANNING
  OPEN_FOR_PREFERENCES
  ASSIGNING
  FINALIZED
  COMPLETED
}

enum AssignmentType {
  ALGORITHM
  MANUAL
  RANDOM
  SWAP
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  PREFERENCE_SUBMIT
  ASSIGNMENT_RUN
  MANUAL_SWAP
  EXPORT
}

enum EntityType {
  TEAM_MEMBER
  SHIFT
  ASSIGNMENT
  PREFERENCE
  CONFIG
}

model TeamMember {
  id              String           @id @default(cuid())
  alias           String           @unique
  avatarId        String
  experienceLevel ExperienceLevel
  genderRole      String
  capabilities    Role[]
  isActive        Boolean          @default(true)

  preferences     ShiftPreference[]
  assignments     Assignment[]
  auditLogs       AuditLog[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([alias])
}

model Event {
  id        String      @id @default(cuid())
  name      String
  startDate DateTime
  endDate   DateTime
  status    EventStatus @default(PLANNING)

  shifts    Shift[]
  config    EventConfig?

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model Shift {
  id                String          @id @default(cuid())
  eventId           String
  event             Event           @relation(fields: [eventId], references: [id])

  type              ShiftType
  startTime         DateTime
  endTime           DateTime
  durationMinutes   Int
  priority          ShiftPriority   @default(CORE)
  desirabilityScore Int             @default(3)
  isTemplate        Boolean         @default(false)

  requiredRoles     ShiftRole[]
  capacity          Int             @default(2)

  preferences       ShiftPreference[]
  assignments       Assignment[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([eventId, startTime])
  @@index([type, priority])
}

model ShiftRole {
  id      String @id @default(cuid())
  shiftId String
  shift   Shift  @relation(fields: [shiftId], references: [id])
  role    Role
  count   Int    @default(1)

  @@unique([shiftId, role])
}

model ShiftPreference {
  id           String      @id @default(cuid())
  teamMemberId String
  teamMember   TeamMember  @relation(fields: [teamMemberId], references: [id])
  shiftId      String
  shift        Shift       @relation(fields: [shiftId], references: [id])

  priority     Int         @default(1)
  notes        String?

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([teamMemberId, shiftId])
  @@index([shiftId])
}

model Assignment {
  id            String         @id @default(cuid())
  shiftId       String
  shift         Shift          @relation(fields: [shiftId], references: [id])
  teamMemberId  String
  teamMember    TeamMember     @relation(fields: [teamMemberId], references: [id])

  role          Role
  isLead        Boolean        @default(false)
  assignmentType AssignmentType @default(ALGORITHM)
  algorithmScore Json?
  notes         String?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([shiftId, teamMemberId])
  @@index([teamMemberId])
  @@index([shiftId])
}

model EventConfig {
  id                   String   @id @default(cuid())
  eventId              String   @unique
  event                Event    @relation(fields: [eventId], references: [id])

  minShiftsPerPerson   Int      @default(2)
  algorithmWeights     Json
  balanceThresholds    Json
  autoAssignUnfilled   Boolean  @default(true)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model AuditLog {
  id         String     @id @default(cuid())
  userId     String?
  user       TeamMember? @relation(fields: [userId], references: [id])

  action     AuditAction
  entityType EntityType
  entityId   String

  before     Json?
  after      Json?
  reason     String?
  ipAddress  String?

  createdAt  DateTime   @default(now())

  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([action])
}

model SystemConfig {
  id        String  @id @default(cuid())
  key       String  @unique
  value     Json

  updatedAt DateTime @updatedAt
}

